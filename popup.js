const videoList = [
    {
        title: "for when it’s warmer",
        videoId: "hG6YzmvbosI",
        videoOwnerChannelTitle: "sleepy fish - Topic",
        videoOwnerChannelId: "UCNR1Pzl2T9biZWAbOXZPUwQ",
    },
    {
        title: "Lofi Hip Hop | Leaves",
        videoId: "F1tAoCuof6c",
        videoOwnerChannelTitle: "TSN Vibes",
        videoOwnerChannelId: "UC1Z4DDUyXeGFSIL7FR-vFQg",
    },
    {
        title: "Chilling With Lofi",
        videoId: "M6zDqbdYLYo",
        videoOwnerChannelTitle: "Sad Music - Topic",
        videoOwnerChannelId: "UC9snFmgnSARriqBNhk4D_cw",
    },
    {
        title: "Peaceful Sleep",
        videoId: "XPpYWLl-O10",
        videoOwnerChannelTitle: "No Spirit - Topic",
        videoOwnerChannelId: "UCraRksyJpUyJQexB7-hdoTQ",
    },
    {
        title: "2021 Is All Jazz",
        videoId: "fHXaNXA_NKc",
        videoOwnerChannelTitle: "Lofi Sleep Chill & Study - Topic",
        videoOwnerChannelId: "UC1itStv5HQODNJr1zyUmDyg",
    },
    {
        title: "Blankets",
        videoId: "HdXrkgZP438",
        videoOwnerChannelTitle: "Aso - Topic",
        videoOwnerChannelId: "UCgWzwhihlRaf6t4Bu8cRh6w",
    },
    {
        title: "When I See You",
        videoId: "xbxW2_icZjM",
        videoOwnerChannelTitle: "Kudasaibeats - Topic",
        videoOwnerChannelId: "UCumJMf6sc_oiLpIElQWUiOQ",
    },
    {
        title: "Birds",
        videoId: "xoopso_csJE",
        videoOwnerChannelTitle: "Allem Iversom - Topic",
        videoOwnerChannelId: "UC7oHoI9Xs-QAR81y6TjikyA",
    },
    {
        title: "Rainforest",
        videoId: "Arx6UcDo0T0",
        videoOwnerChannelTitle: "Saib - Topic",
        videoOwnerChannelId: "UCw02oGFeqYXl14LcyKhOTYw",
    },
    {
        title: "Silience",
        videoId: "cyKX1uZgtt8",
        videoOwnerChannelTitle: "Toonorth - Topic",
        videoOwnerChannelId: "UCF_6iylCppB8bwhnW3HmcRw",
    },
    {
        title: "Move Together",
        videoId: "atOeCrsxNoE",
        videoOwnerChannelTitle: "Yasper - Topic",
        videoOwnerChannelId: "UCo0JVM02GNDSKXAoE4JrUYQ",
    },
    {
        title: "Slow Drive",
        videoId: "wy1R4zcBNZ4",
        videoOwnerChannelTitle: "ChillHop - Topic",
        videoOwnerChannelId: "UCvuWT6OEzQga3mNlgInpYnQ",
    },
    {
        title: "Meaux",
        videoId: "aPHPbb2kFz4",
        videoOwnerChannelTitle: "Ian Ewing - Topic",
        videoOwnerChannelId: "UC93IJn52Fc5tVWcSA3GHbzg",
    },
    {
        title: "Soulful",
        videoId: "fs0BCIUQ7Ws",
        videoOwnerChannelTitle: "L'Indécis - Topic",
        videoOwnerChannelId: "UCxXn2yb4qJbG0bKmr3wa4JA",
    },
    {
        title: "Daybreak",
        videoId: "y3PKcVd7UtM",
        videoOwnerChannelTitle: "cocabona - Topic",
        videoOwnerChannelId: "UCGufCXbmC64ajXVhIaCTpqw",
    },
    {
        title: "Velocities",
        videoId: "JgI6z6aQhEA",
        videoOwnerChannelTitle: "sleepy fish - Topic",
        videoOwnerChannelId: "UCNR1Pzl2T9biZWAbOXZPUwQ",
    },
    {
        title: "2020",
        videoId: "xuXUkynqITU",
        videoOwnerChannelTitle: "idealism - Topic",
        videoOwnerChannelId: "UCOc-AHiKRo_Z8rSHPM74Wag",
    },
    {
        title: "Your Favorite Place",
        videoId: "xaVAPmR6JMg",
        videoOwnerChannelTitle: "Joey Pecoraro - Topic",
        videoOwnerChannelId: "UCT2-ZDqZq35BUz_gA7tYRWg",
    },
    {
        title: "Forest Lake Walk",
        videoId: "qGVMBirxwWc",
        videoOwnerChannelTitle: "No Spirit - Topic",
        videoOwnerChannelId: "UCraRksyJpUyJQexB7-hdoTQ",
    },
    {
        title: "faces",
        videoId: "S8p0crahq3A",
        videoOwnerChannelTitle: "Austin Chen - Topic",
        videoOwnerChannelId: "UCrsVHlnA_bA6kZ7rQW8ZnbA",
    },
    {
        title: "Soul Food",
        videoId: "XznpSTBVliM",
        videoOwnerChannelTitle: "Ruck P - Topic",
        videoOwnerChannelId: "UCdltCBFLglVYUCuyvMEk7BA",
    },
    {
        title: "Hanging Lanterns",
        videoId: "cukiBQ18NgE",
        videoOwnerChannelTitle: "Kalaido - Topic",
        videoOwnerChannelId: "UCnX3dJnTo1kf0zZuPcED_FA",
    },
    {
        title: "Valley",
        videoId: "yApGAVGvKDs",
        videoOwnerChannelTitle: "Leavv   - Topic",
        videoOwnerChannelId: "UC7l9fvTjR75Ul_Zexmb5z-w",
    },
    {
        title: "Lofi Chill",
        videoId: "h6TzXFARexQ",
        videoOwnerChannelTitle: "Sad Music - Topic",
        videoOwnerChannelId: "UC9snFmgnSARriqBNhk4D_cw",
    },
    {
        title: "Jazzy Nights",
        videoId: "Rq6Z-HzojV0",
        videoOwnerChannelTitle: "Lofi Sleep Chill & Study - Topic",
        videoOwnerChannelId: "UC1itStv5HQODNJr1zyUmDyg",
    },
    {
        title: "Velvet Garden",
        videoId: "ULgPNlTfinM",
        videoOwnerChannelTitle: "City Girl - Topic",
        videoOwnerChannelId: "UCWGqmBzWyhxn8a-YDSfb_LA",
    },
    {
        title: "Whale Call",
        videoId: "zIo1kXQuVz0",
        videoOwnerChannelTitle: "Saib - Topic",
        videoOwnerChannelId: "UCw02oGFeqYXl14LcyKhOTYw",
    },
    {
        title: "Lunar Drive",
        videoId: "WryLH9_cRkM",
        videoOwnerChannelTitle: "Mondo Loops - Topic",
        videoOwnerChannelId: "UCNFKlIyDJTdmV1oeHdSZ0Xg",
    },
    {
        title: "Wistful",
        videoId: "n9LXXyHjg3w",
        videoOwnerChannelTitle: "Toonorth - Topic",
        videoOwnerChannelId: "UCF_6iylCppB8bwhnW3HmcRw",
    },
    {
        title: "Pastel Plains",
        videoId: "Eh0ooPop5Ps",
        videoOwnerChannelTitle: "fantompower - Topic",
        videoOwnerChannelId: "UCVP1F5TF-aBurJkAdPMpW6g",
    },
];

const listOfActions = [
    {
        name: "play",
        action: (domElement, musicState) => {
            const playBtn = domElement.getPlayBtn();
            const pauseBtn = domElement.getPauseBtn();
            playBtn.disabled = true;
            pauseBtn.disabled = false;
            playBtn.style.display = "none";
            pauseBtn.style.display = "block";
            const state = {
                buttonState: "play",
                musicState: musicState,
            };
            saveButtonState(state);
        },
    },
    {
        name: "pause",
        action: (domElement, musicState) => {
            const playBtn = domElement.getPlayBtn();
            const pauseBtn = domElement.getPauseBtn();
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            playBtn.style.display = "block";
            pauseBtn.style.display = "none";
            const state = {
                buttonState: "pause",
                musicState: musicState,
            };
            saveButtonState(state);
        },
    },
    {
        name: "prev",
        action: (domElement, musicState) => {
            const songTitle = domElement.getSongTitle();
            const songArtist = domElement.getSongArtist();
            songTitle.textContent = musicState.title;
            songArtist.textContent = musicState.videoOwnerChannelTitle;
            const state = {
                buttonState: "play",
                domElement: domElement,
                musicState: musicState,

            }
            handleButtonState(state)
        },
    },
    {
        name: "next",
        action: (domElement, musicState) => {
            const songTitle = domElement.getSongTitle();
            const songArtist = domElement.getSongArtist();
            songTitle.textContent = musicState.title;
            songArtist.textContent = musicState.videoOwnerChannelTitle;
            const state = {
                buttonState: "play",
                domElement: domElement,
                musicState: musicState,

            }
            handleButtonState(state)
        },
    },
];

function createDocument() {
    const playBtn = document.getElementById("play");
    const pauseBtn = document.getElementById("pause");
    const songTitle = document.getElementById("song-title");
    const songArtist = document.getElementById("song-artist");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");

    return {
        getPlayBtn: () => {
            return playBtn;
        },
        getPauseBtn: () => {
            return pauseBtn;
        },
        getSongTitle: () => {
            return songTitle;
        },
        getSongArtist: () => {
            return songArtist;
        },
        getPrevBtn: () => {
            return prevBtn;
        },
        getNextBtn: () => {
            return nextBtn;
        },
    };
}

function createMusicState() {
    let currMusicState = {
        positionIndex: 0,
        title: "Default Title",
        videoId: "",
        videoOwnerChannelTitle: "Default Channel",
        videoOwnerChannelId: "",
    };

    function constructMusicState(newMusicState, newIndex) {
        const musicState = {
                positionIndex: newIndex,
            ...newMusicState
        }
        return musicState;
    }

    function handlePrevMusicState(videoList) {
        const currMusicIndex = currMusicState.positionIndex
        let prevVideoList = {}, prevMusicState = {}, newIndex = 0;
        const isNotFirstIndexMusic = currMusicIndex > 0;

        newIndex = isNotFirstIndexMusic
            ? currMusicIndex - 1
            : videoList.length - 1;

        prevVideoList = videoList[newIndex];
         prevMusicState = constructMusicState(prevVideoList, newIndex)
        return prevMusicState;
    }

    function handleNextMusicState(videoList) {
        const currMusicIndex = currMusicState.positionIndex
        let nextVideoList = {}, nextMusicState = {}, newIndex = 0;
        const isNotLastIndexMusic = currMusicIndex < videoList.length - 1
        
        newIndex  = isNotLastIndexMusic
            ? currMusicIndex + 1
            : 0

        nextVideoList = videoList[newIndex];
        nextMusicState = constructMusicState(nextVideoList, newIndex)
        return nextMusicState;
    }

    return {
        getMusicState: () => {
            return currMusicState;
        },
        setMusicState: (newMusicState, newIndex) => {
            const musicState = constructMusicState(newMusicState, newIndex)
            currMusicState = musicState;
        },
        getPrevMusicState: (videoList) => {
            const prevMusicState = handlePrevMusicState(videoList)
            return prevMusicState;
        },
        getNextMusicState: (videoList) => {
            const nextMusicState = handleNextMusicState(videoList)
            return nextMusicState;
        },
    };
}

function handleMusicLayout(domElement, musicState) {
    const { title, videoOwnerChannelTitle } = musicState;
    domElement.getSongTitle().textContent = title;
    domElement.getSongArtist().textContent = videoOwnerChannelTitle;
}

function handleButtonState(action) {
    const { buttonState, domElement, musicState } = action;
    for (const item of listOfActions) {
        if (item.name === buttonState) {
            item.action(domElement, musicState);
            break;
        }
    }
}

// TODO:
// - go to the next song, if current song is finished

function init() {
    const currMusicState = createMusicState();
    const domElement = createDocument();

    chrome.storage.local.get(["buttonState", "musicState"], (result) => {
        const { buttonState, musicState } = result;
        const availableState = buttonState || "pause";

        const randomIndexMusic = Math.floor(Math.random() * videoList.length);
        const availableMusicState = musicState || videoList[randomIndexMusic];

        currMusicState.setMusicState(availableMusicState, randomIndexMusic);
        handleMusicLayout(domElement, availableMusicState);
        const sendState = {
            domElement: domElement,
            buttonState: availableState,
            musicState: availableMusicState,
        };
        handleButtonState(sendState);
    });


    domElement.getPrevBtn().addEventListener("click", () => {
        const prevMusicState = currMusicState.getPrevMusicState(videoList)
        currMusicState.setMusicState(prevMusicState, prevMusicState.positionIndex);
        chrome.runtime.sendMessage({
            action: "play",
            data: currMusicState.getMusicState(),
        });
        const sendState = {
            domElement: domElement,
            buttonState: "prev",
            musicState: currMusicState.getMusicState(),
        };
        handleButtonState(sendState);
    });

    domElement.getPlayBtn().addEventListener("click", () => {
        chrome.runtime.sendMessage({
            action: "play",
            data: currMusicState.getMusicState(),
        });
        const sendState = {
            domElement: domElement,
            buttonState: "play",
            musicState: currMusicState.getMusicState(),
        };
        handleButtonState(sendState);
    });

    domElement.getPauseBtn().addEventListener("click", () => {
        chrome.runtime.sendMessage({
            action: "pause",
            data: currMusicState.getMusicState(),
        });
        const sendState = {
            domElement: domElement,
            buttonState: "pause",
            musicState: currMusicState.getMusicState(),
        };
        handleButtonState(sendState);
    });

    domElement.getNextBtn().addEventListener("click", () => {
        const nextMusicState = currMusicState.getNextMusicState(videoList)
        currMusicState.setMusicState(nextMusicState, nextMusicState.positionIndex);
        chrome.runtime.sendMessage({
            action: "play",
            data: currMusicState.getMusicState(),
        });
        const sendState = {
            domElement: domElement,
            buttonState: "next",
            musicState: currMusicState.getMusicState(),
        };
        handleButtonState(sendState);
    });
}

function saveButtonState(state) {
    const { buttonState, musicState } = state;
    chrome.storage.local.set({
        buttonState: buttonState,
        musicState: musicState,
    });
}

init();
